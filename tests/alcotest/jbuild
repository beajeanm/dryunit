(executables
 ((names (main normalize))
  (libraries (alcotest))
  (preprocess (pps (ppx_dryunit)))))

(rule
 ((targets (main.output))
  (deps    (main.exe))
  (action  (with-stdout-to ${@} (run ${<} --json)))))

(rule
 ((targets (main.normalized))
  (deps    (normalize.exe main.output))
  (action  (with-stdout-to ${@} (run ${<})))))

(alias
 ((name   runtest)
  (deps   (main.expected main.normalized))
  (action (run diff -u main.expected main.normalized))))


(alias
 ((name dryunit)
  (deps (*.ml))
  (action (run echo "Dryunit updated"))
))

(rule
((targets (main.ml))
 (deps    (../../src/dryunit/dryunit.exe))
 (action  (with-stdout-to ${@} (run ${<} --gen alcotest)))))
